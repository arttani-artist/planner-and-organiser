<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>productivity lesgoo</title>
<style>
  :root{
    --bg:#0f0f10;
    --panel:#171717;
    --text:#eaeaea;
    --muted:#bdbdbd;
    --accent:#00bfa6;
    --accent-2:#6ef0cf;
    --confetti:#ffd166;
    --card-radius:14px;
    font-family: Inter, Roboto, Arial, sans-serif;
  }

  .theme-cottage{ --bg:#fbf6ef; --panel:#fffaf3; --text:#222; --muted:#666; --accent:#b68d58; --accent-2:#e6c6a0; }
  .theme-goth{ --bg:#0b0b0d; --panel:#0f0f12; --text:#f1e9f7; --muted:#9b90a6; --accent:#8b5cff; --accent-2:#c3a8ff; }
  .theme-pastel{ --bg:#fffafc; --panel:#fff6fb; --text:#231f2e; --muted:#8b7f8a; --accent:#f7b2c4; --accent-2:#c6b3ff; }

  html,body{height:100%; margin:0; background:var(--bg); color:var(--text);}
  .app{
    max-width:1400px;
    margin:18px auto;
    padding:18px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:18px;
  }
  header{
    grid-column: 1 / -1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  header .title{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo{
    width:56px;height:56px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;font-weight:700;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
    color:#fff;font-size:20px;
  }
  h1{font-size:20px;margin:0}
  .streak{
    font-size:14px;color:var(--muted);
    display:flex;gap:8px;align-items:center;
  }
  .points{
    background:var(--panel); padding:10px 14px;border-radius:12px;
    display:flex;gap:10px;align-items:center;
  }
  main{
    display:contents;
  }

  .left, .middle, .right{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    padding:14px;border-radius:var(--card-radius); border:1px solid rgba(255,255,255,0.03);
    display:flex;flex-direction:column; gap:12px;
  }

  .panel-title{font-size:14px;margin:0 0 8px 0;color:var(--muted)}

  .mood-row{display:flex;gap:8px;flex-wrap:wrap}
  .mood-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--text)}
  .mood-btn.selected{outline:2px solid rgba(255,255,255,0.06); box-shadow:0 6px 12px rgba(0,0,0,.4)}
  .mood-history{margin-top:12px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px}

  .todo-input{display:flex;gap:8px}
  input[type=text], input[type=time], select, textarea{
    padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);flex:1;
  }
  input[type=number]{
    padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);
  }
  .todo-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;padding-right:6px}
  .task{
    background:var(--panel);padding:10px;border-radius:10px;display:flex;align-items:center;gap:10px;
  }
  .task .label{flex:1}
  .task .cat{font-size:12px;color:var(--muted);padding:4px 8px;border-radius:8px;background:rgba(0,0,0,0.06)}
  .check-btn{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent}

  .timer{
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)
  }
  .time-display{font-size:36px;margin:6px 0}
  .timer-controls{display:flex;gap:8px;margin-top:8px}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;background:var(--accent);color:#081414;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);font-weight:600}

  .shop{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .shop .item{background:var(--panel);padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:6px;width:130px}
  .small{font-size:12px;color:var(--muted)}

  /* Calendar styles (keeps your aesthetic, grid in calendar-grid) */
  .calendar-container{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    border-radius:10px;padding:12px;
  }
  .calendar-header{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;
  }
  .calendar-nav{
    background:transparent;border:1px solid rgba(255,255,255,0.06);
    padding:6px 10px;border-radius:8px;cursor:pointer;color:var(--text);
    font-size:16px;font-weight:600;
  }
  .calendar-nav:hover{
    background:rgba(255,255,255,0.05);
  }
  .calendar-grid{
    display:grid;grid-template-columns:repeat(7,1fr);gap:6px;
  }
  .calendar-day-header{
    text-align:center;padding:6px;font-size:11px;color:var(--muted);font-weight:600;
  }
  .calendar-day{
    aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:8px;
    border-radius:10px;cursor:pointer;position:relative;min-height:68px;
    transition:background-color 0.15s ease, transform 0.08s ease;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    border:1px solid rgba(255,255,255,0.02);
  }
  .calendar-day:hover{ transform: translateY(-4px); background: rgba(255,255,255,0.03) }
  .calendar-day.today{background:var(--accent);color:#071413}
  .calendar-day.other-month{color:var(--muted);opacity:0.45}
  .calendar-day.has-events{box-shadow: 0 0 0 2px rgba(110,240,207,0.08) inset;}
  .day-number{font-size:12px;font-weight:700}
  .event-dot{width:6px;height:6px;border-radius:50%;background:var(--accent-2);margin-top:6px}

  .event-item{
    background:var(--panel);padding:8px 12px;border-radius:8px;margin-bottom:6px;
    display:flex;justify-content:space-between;align-items:center;
  }

  @media (max-width:1200px){
    .app{grid-template-columns:1fr 1fr; padding:12px}
    .middle{grid-column:1 / -1}
  }
  @media (max-width:880px){
    .app{grid-template-columns:1fr; padding:12px}
    header{gap:8px}
  }

  .confetti {
    position:relative;pointer-events:none;
  }
  .confetti .dot{
    position:absolute;width:8px;height:8px;border-radius:3px;animation:pop .9s ease-out forwards;
  }
  @keyframes pop {
    0% { transform: translateY(0) scale(0.2); opacity:1 }
    100% { transform: translateY(-90px) translateX(30px) rotate(180deg) scale(1); opacity:0 }
  }

  /* modal styles that match the app aesthetic */
  .modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(2,6,9,0.6);
    z-index: 9999;
    padding: 18px;
  }
  .modal.hidden { display:none; }
  .modal-card {
    width: min(520px, 96%);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius: 14px;
    padding: 14px;
    border: 1px solid rgba(255,255,255,0.04);
    color: var(--text);
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  }
  .modal-header{ display:flex;justify-content:space-between;align-items:center;gap:12px }
  .modal-title{ font-weight:700 }
  .modal-close{ background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:20px }
  .modal-body{ margin-top:10px; display:grid; gap:8px }
  .modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }
  .modal-events{ margin-top:8px; max-height:220px; overflow:auto; padding-top:6px }
  .modal-event-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background:rgba(255,255,255,0.01); }
  .tiny-btn{ padding:6px 8px; border-radius:8px; border:0; cursor:pointer; font-size:13px }
  .tiny-btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text) }
  .tiny-btn.danger{ background:#2b0a0f; color:#fff; }
</style>
</head>
<body>
  <div id="app" class="">
    <div class="app" id="appgrid">
      <header>
        <div class="title">
          <div class="logo">v</div>
          <div>
            <h1>vibe productivity hub</h1>
            <div class="streak"><span id="streakText">streak: 0</span></div>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div class="points" title="points you can spend">
            <div style="font-weight:700" id="points">0</div>
            <div class="small">points</div>
          </div>
          <button class="btn secondary" id="openShopBtn">shop</button>
        </div>
      </header>

      <main>
        <section class="left">
          <div>
            <p class="panel-title">mood tracker</p>
            <div class="mood-row" id="moodBtns">
              <!-- buttons injected by js -->
            </div>

            <div class="mood-history">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="small">mood history (last 14 days)</div>
                <button id="clearMood" class="btn secondary" style="padding:6px 8px">clear</button>
              </div>
              <canvas id="moodCanvas" width="700" height="120" style="width:100%;height:60px;margin-top:8px;border-radius:8px"></canvas>
            </div>
          </div>

          <hr style="margin:14px 0;border:0;border-top:1px solid rgba(255,255,255,0.03)">

          <div>
            <p class="panel-title">daily quick</p>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="text" id="quickTask" placeholder="add quick task..." />
              <select id="quickCat">
                <option value="school">school</option>
                <option value="chores">chores</option>
                <option value="personal">personal</option>
              </select>
              <button id="addQuick" class="btn">add</button>
            </div>
            <div style="margin-top:10px" id="todoContainer">
              <div class="todo-list" id="todoList"></div>
            </div>
          </div>
        </section>

        <section class="middle">
          <div>
            <p class="panel-title">calendar planner</p>
            <div class="calendar-container">
              <div class="calendar-header">
                <button class="calendar-nav" id="prevMonth">â€¹</button>
                <div style="font-weight:600" id="calendarTitle">January 2025</div>
                <button class="calendar-nav" id="nextMonth">â€º</button>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div style="margin-top:12px">
              <div class="small" style="margin-bottom:8px">upcoming events</div>
              <div id="eventsList"></div>
            </div>
          </div>
        </section>

        <section class="right">
          <div>
            <p class="panel-title">pomodoro study timer</p>
            <div class="timer" id="timerCard">
              <div class="small">session length (min)</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="workLen" type="number" value="25" min="5" style="width:80px"/>
                <input id="breakLen" type="number" value="5" min="1" style="width:80px"/>
              </div>

              <div class="time-display" id="timeDisplay">25:00</div>
              <div class="timer-controls">
                <button id="startPause" class="btn">start</button>
                <button id="skip" class="btn secondary">skip</button>
                <button id="reset" class="btn secondary">reset</button>
              </div>
              <div style="margin-top:8px;color:var(--muted);font-size:13px">mode: <span id="timerMode">work</span></div>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;gap:12px;flex-direction:column">
            <div>
              <p class="panel-title">rewards shop</p>
              <div class="shop" id="shop">
                <div class="item">
                  <div style="font-weight:700">goth theme</div>
                  <div class="small">cost: 200</div>
                  <button data-item="goth" class="btn buy">buy</button>
                </div>
                <div class="item">
                  <div style="font-weight:700">pastel theme</div>
                  <div class="small">cost: 150</div>
                  <button data-item="pastel" class="btn buy">buy</button>
                </div>
                <div class="item">
                  <div style="font-weight:700">cottage theme</div>
                  <div class="small">cost: 100</div>
                  <button data-item="cottage" class="btn buy">buy</button>
                </div>
              </div>
            </div>

            <div>
              <p class="panel-title">profile</p>
              <div style="background:var(--panel);padding:12px;border-radius:10px">
                <div style="font-weight:700" id="profileName">you</div>
                <div class="small" style="margin-top:6px">stickers unlocked:</div>
                <div id="stickers" style="display:flex;gap:6px;margin-top:8px">
                  <!-- little sticker placeholders -->
                </div>
                <div style="margin-top:10px">
                  <button id="useTheme" class="btn secondary">apply unlocked theme</button>
                </div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- modal for adding/viewing events -->
  <div id="dateModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalDateLabel">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modalDateLabel">date</div>
          <div class="small" id="modalDatePretty" style="margin-top:6px;color:var(--muted)"></div>
        </div>
        <button class="modal-close" id="modalCloseBtn" title="close">âœ•</button>
      </div>

      <div class="modal-body">
        <input type="text" id="modalTitle" placeholder="event / task title" />
        <div style="display:flex;gap:8px">
          <input type="time" id="modalTime" style="width:120px" />
          <select id="modalCategory" style="width:140px">
            <option value="school">school</option>
            <option value="personal">personal</option>
            <option value="work">work</option>
            <option value="social">social</option>
          </select>
        </div>
        <textarea id="modalDesc" rows="3" placeholder="details (optional)"></textarea>

        <div class="modal-actions">
          <button id="modalSave" class="btn">save</button>
          <button id="modalCancel" class="btn secondary">cancel</button>
        </div>

        <div style="margin-top:10px">
          <div class="small" style="margin-bottom:8px">events for this day</div>
          <div class="modal-events" id="modalEventsList"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  cleaned + fixed calendar modal integration.
  - click on calendar day -> modal opens
  - save inside modal -> saved into state.events and persisted
  - modal shows existing events for that date with delete buttons
  - prev/next month navigation works
  - upcoming events list updated
*/

// ----- constants & defaults -----
const MOODS = [
  {id:6, emoji:'ðŸ˜„', label:'great'},
  {id:5, emoji:'ðŸ™‚', label:'good'},
  {id:4, emoji:'ðŸ˜', label:'meh'},
  {id:3, emoji:'ðŸ˜¡', label:'angry'},
  {id:2, emoji:'ðŸ˜•', label:'down'},
  {id:1, emoji:'ðŸ˜«', label:'awful'},
  {id:0, emoji:'ðŸ«¥', label:'numb'}
];

const DEFAULTS = {
  points: 0,
  streak: 0,
  lastStreakDate: null,
  moods: [],
  todos: [],
  events: [], // {id, date: 'YYYY-MM-DD', title, time, category, desc, created}
  shop: { goth:false, pastel:false, cottage:false },
  appliedTheme: null
};

// ----- storage helpers -----
function load(){ return JSON.parse(localStorage.getItem('vibe_data')||'null') || DEFAULTS; }
function save(state){ localStorage.setItem('vibe_data', JSON.stringify(state)); }

// ----- app state -----
let state = load();
let currentCalendarDate = new Date();
let selectedCalendarDate = null; // Date object for modal

// ----- dom refs -----
const moodBtns = document.getElementById('moodBtns');
const moodCanvas = document.getElementById('moodCanvas');
const todoList = document.getElementById('todoList');
const pointsEl = document.getElementById('points');
const streakText = document.getElementById('streakText');
const quickTask = document.getElementById('quickTask');
const quickCat = document.getElementById('quickCat');
const addQuick = document.getElementById('addQuick');
const workLen = document.getElementById('workLen');
const breakLen = document.getElementById('breakLen');
const timeDisplay = document.getElementById('timeDisplay');
const startPause = document.getElementById('startPause');
const skipBtn = document.getElementById('skip');
const resetBtn = document.getElementById('reset');
const timerMode = document.getElementById('timerMode');
const buyBtns = document.querySelectorAll('.buy');
const openShopBtn = document.getElementById('openShopBtn');
const useThemeBtn = document.getElementById('useTheme');
const stickersEl = document.getElementById('stickers');
const clearMoodBtn = document.getElementById('clearMood');

const calendarGrid = document.getElementById('calendarGrid');
const calendarTitle = document.getElementById('calendarTitle');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');

const eventsList = document.getElementById('eventsList');

// modal refs
const dateModal = document.getElementById('dateModal');
const modalDatePretty = document.getElementById('modalDatePretty');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const modalSave = document.getElementById('modalSave');
const modalCancel = document.getElementById('modalCancel');
const modalTitle = document.getElementById('modalTitle');
const modalTime = document.getElementById('modalTime');
const modalCategory = document.getElementById('modalCategory');
const modalDesc = document.getElementById('modalDesc');
const modalEventsList = document.getElementById('modalEventsList');

// helper: YYYY-MM-DD
function formatDate(d){
  if(!d) return '';
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function parseDateFromYMD(s){
  // ensure local midnight
  return new Date(s + 'T00:00:00');
}

// ----- init UI -----
function init(){
  // normalize state
  if(typeof state.points === 'undefined') state.points = 0;
  if(!Array.isArray(state.todos)) state.todos = [];
  if(!Array.isArray(state.events)) state.events = [];
  if(!state.shop) state.shop = {goth:false,pastel:false,cottage:false};
  save(state);

  renderMoodButtons();
  renderMoodCanvas();
  renderTodos();
  renderCalendar();
  renderUpcomingEvents();
  updateProfileUI();
  updatePointsUI();
  updateStreakUI();
  applyTheme(state.appliedTheme);
}
init();

// ----- mood tracker -----
function renderMoodButtons(){
  moodBtns.innerHTML = '';
  MOODS.forEach(m=>{
    const btn = document.createElement('button');
    btn.className = 'mood-btn';
    btn.innerHTML = `${m.emoji} <span style="margin-left:8px;font-size:13px;color:var(--muted)">${m.label}</span>`;
    btn.onclick = ()=> logMood(m.id);
    moodBtns.appendChild(btn);
  });
}
function logMood(moodId){
  const today = formatDate(new Date());
  state.moods = state.moods.filter(m=>m.date!==today);
  state.moods.push({date:today, moodId});
  if(state.moods.length>60) state.moods.splice(0,state.moods.length-60);
  save(state);
  renderMoodCanvas();
  updateStreakOnMood(today);
}
function renderMoodCanvas(){
  const canvas = moodCanvas;
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const days = 14;
  const arr = [];
  const today = new Date();
  for(let i=days-1;i>=0;i--){
    const d = new Date(today); d.setDate(today.getDate()-i);
    const key = formatDate(d);
    const found = state.moods.find(m=>m.date===key);
    arr.push(found ? found.moodId : null);
  }
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const w = canvas.width;
  const h = canvas.height;
  const pad = 10;
  const cellW = (w - pad*2) / days;
  for(let i=0;i<days;i++){
    const val = arr[i];
    const x = pad + i*cellW;
    const barH = val ? ( (val/6) * (h - pad*2) ) : 6;
    ctx.fillStyle = val ? 'rgba(0,191,166,0.9)' : 'rgba(255,255,255,0.04)';
    ctx.fillRect(x+6, h - pad - barH, cellW - 12, barH);
  }
  for(let i=0;i<days;i++){
    const val = arr[i];
    const x = pad + i*cellW + cellW/2;
    if(val){
      const y = h - pad - (val/6)*(h - pad*2) - 8;
      ctx.beginPath();
      ctx.arc(x,y,6,0,Math.PI*2);
      ctx.fillStyle = 'var(--accent)';
      ctx.fill();
    }
  }
}
clearMoodBtn.onclick = ()=>{
  if(!confirm('clear mood history?')) return;
  state.moods = [];
  save(state);
  renderMoodCanvas();
};

// ----- todos -----
function renderTodos(){
  todoList.innerHTML = '';
  state.todos.sort((a,b)=> b.created - a.created);
  for(const t of state.todos){
    const el = document.createElement('div');
    el.className = 'task';
    el.innerHTML = `
      <button class="check-btn">${t.done ? 'âœ“' : ''}</button>
      <div class="label">
        <div style="font-weight:700; color:${t.done ? 'var(--muted)' : 'var(--text)'}">${escapeHtml(t.text)}</div>
        <div class="cat">${escapeHtml(t.cat)}</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn secondary edit">edit</button>
        <button class="btn secondary del">del</button>
      </div>
    `;
    el.querySelector('.check-btn').onclick = ()=>{
      toggleTaskDone(t.id, el);
    };
    el.querySelector('.del').onclick = ()=> {
      if(!confirm('delete task?')) return;
      state.todos = state.todos.filter(x=>x.id!==t.id);
      save(state); renderTodos();
    };
    el.querySelector('.edit').onclick = ()=>{
      const newText = prompt('edit task text', t.text);
      if(newText!==null){
        t.text = newText.trim() || t.text;
        save(state); renderTodos();
      }
    };
    todoList.appendChild(el);
  }
}
function addTask(text, cat='personal'){
  const id = Math.random().toString(36).slice(2,9);
  const task = {id, text, cat, done:false, created:Date.now()};
  state.todos.push(task);
  save(state);
  renderTodos();
}
addQuick.onclick = ()=>{
  const txt = quickTask.value.trim();
  if(!txt) return;
  addTask(txt, quickCat.value);
  quickTask.value = '';
};
function toggleTaskDone(id, el){
  const t = state.todos.find(x=>x.id===id);
  if(!t) return;
  t.done = !t.done;
  if(t.done){
    addPoints(12);
    spawnConfetti(el);
    const today = formatDate(new Date());
    if(state.moods.find(m=>m.date===today)) {
      updateStreakOnTask(today);
    }
  }
  save(state);
  renderTodos();
}

// ----- points / profile / shop -----
function addPoints(n){
  state.points = (state.points||0) + n;
  save(state);
  updatePointsUI();
}
function updatePointsUI(){ pointsEl.textContent = state.points || 0; }

buyBtns.forEach(b=>{
  b.onclick = ()=>{
    const item = b.dataset.item;
    const cost = item==='goth' ? 200 : (item==='pastel' ? 150 : 100);
    if(state.shop[item]){
      alert('already bought!');
      return;
    }
    if(state.points < cost){
      alert('not enough points yet!');
      return;
    }
    state.points -= cost;
    state.shop[item] = true;
    state.appliedTheme = item;
    save(state);
    updatePointsUI();
    applyTheme(item);
    updateProfileUI();
    alert('bought! theme unlocked and applied');
  };
});
openShopBtn.onclick = ()=> {
  document.getElementById('shop').scrollIntoView({behavior:'smooth', block:'center'});
};
useThemeBtn.onclick = ()=>{
  const unlocked = Object.keys(state.shop).filter(k=>state.shop[k]);
  if(!unlocked.length){ alert('no themes unlocked yet'); return; }
  const pick = unlocked[0];
  state.appliedTheme = pick;
  save(state);
  applyTheme(pick);
  alert('applied: ' + pick);
};
function updateProfileUI(){
  stickersEl.innerHTML = '';
  const keys = Object.keys(state.shop);
  keys.forEach(k=>{
    if(state.shop[k]){
      const s = document.createElement('div');
      s.style.width='28px';s.style.height='28px';s.style.borderRadius='6px';
      s.style.background='linear-gradient(135deg,var(--accent),var(--accent-2))';
      s.title = k + ' theme';
      stickersEl.appendChild(s);
    }
  });
}

// ----- timer -----
let timer = { running:false, mode:'work', remain: null, intervalId: null };
function setTimerMinutes(mins){ timer.remain = mins * 60; renderTimerDisplay(); }
function renderTimerDisplay(){
  const mm = Math.floor(timer.remain/60).toString().padStart(2,'0');
  const ss = (timer.remain%60).toString().padStart(2,'0');
  timeDisplay.textContent = `${mm}:${ss}`;
  timerMode.textContent = timer.mode;
}
function startTimer(){
  if(timer.running) return;
  if(timer.remain===null) setTimerMinutes(parseInt(workLen.value,10)||25);
  timer.running = true;
  startPause.textContent = 'pause';
  timer.intervalId = setInterval(()=>{
    timer.remain--;
    if(timer.remain<=0){
      clearInterval(timer.intervalId);
      timer.running=false;
      startPause.textContent='start';
      if(timer.mode==='work') {
        addPoints(25);
        alert('nice! you finished a work session and earned 25 points');
      }
      if(timer.mode==='work'){ timer.mode='break'; setTimerMinutes(parseInt(breakLen.value,10)||5); }
      else { timer.mode='work'; setTimerMinutes(parseInt(workLen.value,10)||25); }
      renderTimerDisplay();
    } else {
      renderTimerDisplay();
    }
  },1000);
}
function pauseTimer(){
  if(!timer.running) return;
  clearInterval(timer.intervalId);
  timer.running=false;
  startPause.textContent='start';
}
startPause.onclick = ()=>{ if(timer.running){ pauseTimer(); } else { startTimer(); } };
skipBtn.onclick = ()=>{
  if(timer.intervalId) clearInterval(timer.intervalId);
  timer.running=false;
  if(timer.mode==='work'){ timer.mode='break'; setTimerMinutes(parseInt(breakLen.value,10)||5); }
  else { timer.mode='work'; setTimerMinutes(parseInt(workLen.value,10)||25); }
  renderTimerDisplay();
};
resetBtn.onclick = ()=>{
  if(timer.intervalId) clearInterval(timer.intervalId);
  timer.running=false;
  timer.mode='work';
  setTimerMinutes(parseInt(workLen.value,10)||25);
  startPause.textContent='start';
};
setTimerMinutes(parseInt(workLen.value,10)||25);

// ----- escape helper -----
function escapeHtml(s){
  return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// ----- confetti -----
function spawnConfetti(el){
  const conf = document.createElement('div');
  conf.className='confetti';
  conf.style.width='1px'; conf.style.height='1px';
  el.appendChild(conf);
  for(let i=0;i<6;i++){
    const d = document.createElement('div');
    d.className='dot';
    d.style.left = (Math.random()*40) + 'px';
    d.style.top = (Math.random()*10) + 'px';
    d.style.background = ['#ffd166','#06d6a0','#ef476f','#118ab2','#ffb4a2'][Math.floor(Math.random()*5)];
    conf.appendChild(d);
  }
  setTimeout(()=> conf.remove(), 900);
}

// ----- streak logic -----
function updateStreakOnMood(today){
  if(!state.lastStreakDate) state.lastStreakDate = null;
  save(state);
  updateStreakUI();
}
function updateStreakOnTask(today){
  if(!state.moods.find(m=>m.date===today)) return;
  const last = state.lastStreakDate;
  if(last===null){
    state.streak = 1;
  } else {
    const lastDate = new Date(last);
    const expected = new Date(today); expected.setDate(expected.getDate()-1);
    const expectedStr = formatDate(expected);
    if(formatDate(lastDate) === expectedStr) state.streak = (state.streak||0) + 1;
    else state.streak = 1;
  }
  state.lastStreakDate = today;
  addPoints(10);
  save(state);
  updateStreakUI();
}
function updateStreakUI(){ streakText.textContent = 'streak: ' + (state.streak || 0); }

// ----- theme -----
function applyTheme(name){
  document.documentElement.classList.remove('theme-goth','theme-cottage','theme-pastel');
  if(!name) return;
  if(name==='goth') document.documentElement.classList.add('theme-goth');
  if(name==='cottage') document.documentElement.classList.add('theme-cottage');
  if(name==='pastel') document.documentElement.classList.add('theme-pastel');
}

// ----- calendar rendering + modal integration -----
function renderCalendar(){
  const year = currentCalendarDate.getFullYear();
  const month = currentCalendarDate.getMonth();

  calendarTitle.textContent = new Date(year, month).toLocaleDateString('en-US', {month:'long', year:'numeric'});

  calendarGrid.innerHTML = '';

  // day headers
  const dayHeaders = ['sun','mon','tue','wed','thu','fri','sat'];
  dayHeaders.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-day-header';
    header.textContent = day;
    calendarGrid.appendChild(header);
  });

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startDay = firstDay.getDay();

  // previous month trailing days
  if(startDay > 0) {
    const prevLast = new Date(year, month, 0); // last day prev month
    const prevDays = prevLast.getDate();
    for(let i = startDay - 1; i >= 0; i--){
      const dayNum = prevDays - i;
      const dateObj = new Date(year, month - 1, dayNum);
      const dayEl = createCalendarDay(dayNum, true, dateObj);
      calendarGrid.appendChild(dayEl);
    }
  }

  // current month
  for(let day = 1; day <= daysInMonth; day++){
    const dateObj = new Date(year, month, day);
    const dayEl = createCalendarDay(day, false, dateObj);
    calendarGrid.appendChild(dayEl);
  }

  // next month leading days
  const cellsUsed = startDay + daysInMonth;
  const remainingCells = Math.ceil(cellsUsed / 7) * 7 - cellsUsed;
  for(let day = 1; day <= remainingCells; day++){
    const dateObj = new Date(year, month + 1, day);
    const dayEl = createCalendarDay(day, true, dateObj);
    calendarGrid.appendChild(dayEl);
  }
}

function createCalendarDay(dayNum, isOtherMonth, date){
  const dayEl = document.createElement('div');
  dayEl.className = 'calendar-day';
  if(isOtherMonth) dayEl.classList.add('other-month');

  const today = new Date();
  if(formatDate(date) === formatDate(today)) {
    dayEl.classList.add('today');
  }

  const dateStr = formatDate(date);
  const dayEvents = state.events.filter(e => e.date === dateStr);
  if(dayEvents.length > 0) {
    dayEl.classList.add('has-events');
  }

  dayEl.innerHTML = `
    <div class="day-number">${dayNum}</div>
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;margin-top:6px">
      ${dayEvents.slice(0,3).map(() => '<div class="event-dot"></div>').join('')}
    </div>
  `;

  dayEl.onclick = () => openModalForDate(date);
  return dayEl;
}

// open modal for a given Date object
function openModalForDate(dateObj){
  selectedCalendarDate = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()); // strip time
  const pretty = selectedCalendarDate.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric'});
  modalDatePretty.textContent = pretty;
  modalTitle.value = '';
  modalTime.value = '';
  modalDesc.value = '';
  modalCategory.value = 'school';
  renderModalEvents();
  dateModal.classList.remove('hidden');
  dateModal.setAttribute('aria-hidden','false');
  setTimeout(()=> modalTitle.focus(), 120);
}

// render events inside the modal for selectedCalendarDate
function renderModalEvents(){
  modalEventsList.innerHTML = '';
  if(!selectedCalendarDate) return;
  const key = formatDate(selectedCalendarDate);
  const dayEvents = state.events.filter(e => e.date === key).sort((a,b)=>{
    if((a.time||'') === (b.time||'')) return a.created - b.created;
    if(!a.time) return 1;
    if(!b.time) return -1;
    return a.time.localeCompare(b.time);
  });

  if(dayEvents.length === 0){
    modalEventsList.innerHTML = `<div class="small" style="padding:8px;color:var(--muted)">no events for this day</div>`;
    return;
  }

  dayEvents.forEach(ev => {
    const row = document.createElement('div');
    row.className = 'modal-event-row';
    row.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(ev.title)}</div>
        <div class="small" style="margin-top:4px">${ev.time || 'all day'} â€¢ ${escapeHtml(ev.category)}${ev.desc ? ' â€¢ ' + escapeHtml(ev.desc) : ''}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="tiny-btn ghost" data-id="${ev.id}" title="edit">edit</button>
        <button class="tiny-btn danger" data-id="${ev.id}" title="delete">delete</button>
      </div>
    `;
    modalEventsList.appendChild(row);
  });

  // attach edit/delete listeners
  modalEventsList.querySelectorAll('.tiny-btn').forEach(btn=>{
    btn.onclick = (ev)=>{
      const id = btn.dataset.id;
      if(btn.title === 'delete'){
        if(!confirm('delete this event?')) return;
        state.events = state.events.filter(x=>x.id!==id);
        save(state);
        renderCalendar();
        renderModalEvents();
        renderUpcomingEvents();
      } else if(btn.title === 'edit'){
        const e = state.events.find(x=>x.id===id);
        if(!e) return;
        // populate fields for editing: remove event, allow save to create updated
        modalTitle.value = e.title;
        modalTime.value = e.time || '';
        modalCategory.value = e.category || 'school';
        modalDesc.value = e.desc || '';
        // remove the old one (we'll re-add on save)
        state.events = state.events.filter(x=>x.id!==id);
        save(state);
        renderCalendar();
        renderModalEvents();
      }
    };
  });
}

// save from modal
modalSave.onclick = ()=>{
  const title = modalTitle.value.trim();
  if(!title){
    alert('add a title first');
    modalTitle.focus();
    return;
  }
  if(!selectedCalendarDate){
    alert('no date selected');
    return;
  }
  const ev = {
    id: Math.random().toString(36).slice(2,9),
    date: formatDate(selectedCalendarDate),
    title: title,
    time: modalTime.value || '',
    category: modalCategory.value || 'personal',
    desc: modalDesc.value.trim() || '',
    created: Date.now()
  };
  state.events.push(ev);
  save(state);
  addPoints(5);
  renderCalendar();
  renderModalEvents();
  renderUpcomingEvents();
  // clear inputs (ready to add another)
  modalTitle.value = '';
  modalTime.value = '';
  modalDesc.value = '';
  modalTitle.focus();
};

// cancel / close modal
function closeModal(){
  dateModal.classList.add('hidden');
  dateModal.setAttribute('aria-hidden','true');
  selectedCalendarDate = null;
}
modalCancel.onclick = closeModal;
modalCloseBtn.onclick = closeModal;
dateModal.addEventListener('click', (e)=>{
  if(e.target === dateModal) closeModal(); // click outside content closes
});

// keyboard: enter to save when focusing title
modalTitle.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') { e.preventDefault(); modalSave.click(); } });

// prev / next month
prevMonth.onclick = ()=> { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); };
nextMonth.onclick = ()=> { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); };

// upcoming events panel (below calendar)
function renderUpcomingEvents(){
  eventsList.innerHTML = '';
  const now = new Date();
  // find future/present events sorted ascending
  const items = state.events
    .slice()
    .sort((a,b)=> {
      if(a.date === b.date) return (a.time||'').localeCompare(b.time||'') || a.created - b.created;
      return a.date.localeCompare(b.date);
    })
    .slice(0, 50);

  // show next 6 upcoming (today + future)
  const upcoming = items.filter(ev => {
    // compare ymd strings lexicographically works
    return ev.date >= formatDate(now);
  }).slice(0,6);

  if(upcoming.length === 0){
    eventsList.innerHTML = `<div class="small" style="padding:8px;color:var(--muted)">no upcoming events</div>`;
    return;
  }

  upcoming.forEach(ev=>{
    const el = document.createElement('div');
    el.className = 'event-item';
    el.innerHTML = `
      <div class="event-details">
        <div class="event-title">${escapeHtml(ev.title)}</div>
        <div class="event-time small">${ev.date} ${ev.time ? 'â€¢ ' + ev.time : ''} â€¢ ${escapeHtml(ev.category)}</div>
      </div>
      <div class="event-actions">
        <button class="btn secondary open-event" data-id="${ev.id}">open</button>
      </div>
    `;
    eventsList.appendChild(el);
  });

  // open event button opens modal for that event's date
  document.querySelectorAll('.open-event').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const e = state.events.find(x=>x.id===id);
      if(!e) return;
      openModalForDate(parseDateFromYMD(e.date));
      // focus the event list and highlight? (modal will show it)
    };
  });
}
<!-- buttons -->
<div class="top-controls">
  <button id="themeToggle">switch theme</button>
  <button id="mobileToggle">mobile mode</button>
</div>

<style>
  /* top control buttons styling */
  .top-controls {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 10px;
  }
  .top-controls button {
    background: var(--accent);
    color: var(--text);
    border: none;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
  }
  .mobile-mode .sidebar,
  .mobile-mode .widget-panel {
    display: none;
  }
  .mobile-mode .main {
    width: 100%;
    padding: 10px;
  }
</style>

<script>
  const themes = ["dark-dreamy", "original", "alt-theme"]; // replace with actual class names or ids you use
  let currentThemeIndex = 0;

  // load saved preferences
  window.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("theme");
    const savedMobile = localStorage.getItem("mobileMode");

    if (savedTheme && themes.includes(savedTheme)) {
      document.body.classList.add(savedTheme);
      currentThemeIndex = themes.indexOf(savedTheme);
    } else {
      document.body.classList.add(themes[0]);
    }

    if (savedMobile === "true") {
      document.body.classList.add("mobile-mode");
    }
  });

  // theme toggle
  document.getElementById("themeToggle").addEventListener("click", () => {
    document.body.classList.remove(themes[currentThemeIndex]);
    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
    document.body.classList.add(themes[currentThemeIndex]);
    localStorage.setItem("theme", themes[currentThemeIndex]);
  });

  // mobile toggle
  document.getElementById("mobileToggle").addEventListener("click", () => {
    document.body.classList.toggle("mobile-mode");
    localStorage.setItem(
      "mobileMode",
      document.body.classList.contains("mobile-mode")
    );
  });
</script>

// ----- misc helpers -----
(function ensureState(){
  save(state);
})();

document.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && document.activeElement===quickTask) { addQuick.click(); }
  if(e.key==='Escape' && dateModal && !dateModal.classList.contains('hidden')) { closeModal(); }
});

// apply theme on load if any
if(state.appliedTheme) applyTheme(state.appliedTheme);

// save state before unload
window.addEventListener('beforeunload', ()=> save(state));

</script>
</body>
</html>
