<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>productivity lesgoo</title>
<style>
  :root{
    --bg:#0f0f10;
    --panel:#171717;
    --text:#eaeaea;
    --muted:#bdbdbd;
    --accent:#00bfa6; 
    --accent-2:#6ef0cf;
    --confetti:#ffd166;
    --card-radius:14px;
    font-family: Inter, Roboto, Arial, sans-serif;
  }

  .theme-cottage{ --bg:#fbf6ef; --panel:#fffaf3; --text:#222; --muted:#666; --accent:#b68d58; --accent-2:#e6c6a0; }
  .theme-goth{ --bg:#0b0b0d; --panel:#0f0f12; --text:#f1e9f7; --muted:#9b90a6; --accent:#8b5cff; --accent-2:#c3a8ff; }
  .theme-pastel{ --bg:#fffafc; --panel:#fff6fb; --text:#231f2e; --muted:#8b7f8a; --accent:#f7b2c4; --accent-2:#c6b3ff; }

  html,body{height:100%; margin:0; background:var(--bg); color:var(--text);}
  .app{
    max-width:1400px;
    margin:18px auto;
    padding:18px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:18px;
  }
  header{
    grid-column: 1 / -1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  header .title{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo{
    width:56px;height:56px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;font-weight:700;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
    color:#fff;font-size:20px;
  }
  h1{font-size:20px;margin:0}
  .streak{
    font-size:14px;color:var(--muted);
    display:flex;gap:8px;align-items:center;
  }
  .points{
    background:var(--panel); padding:10px 14px;border-radius:12px;
    display:flex;gap:10px;align-items:center;
  }
  main{
    display:contents;
  }

  .left, .middle, .right{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    padding:14px;border-radius:var(--card-radius); border:1px solid rgba(255,255,255,0.03);
    display:flex;flex-direction:column; gap:12px;
  }

  .panel-title{font-size:14px;margin:0 0 8px 0;color:var(--muted)}

  .mood-row{display:flex;gap:8px;flex-wrap:wrap}
  .mood-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--text)}
  .mood-btn.selected{outline:2px solid rgba(255,255,255,0.06); box-shadow:0 6px 12px rgba(0,0,0,.4)}
  .mood-history{margin-top:12px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px}

  .todo-input{display:flex;gap:8px}
  input[type=text], input[type=time], select{
    padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);flex:1;
  }
  input[type=number]{
    padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);
  }
  .todo-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;padding-right:6px}
  .task{
    background:var(--panel);padding:10px;border-radius:10px;display:flex;align-items:center;gap:10px;
  }
  .task .label{flex:1}
  .task .cat{font-size:12px;color:var(--muted);padding:4px 8px;border-radius:8px;background:rgba(0,0,0,0.06)}
  .check-btn{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent}

  .timer{
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)
  }
  .time-display{font-size:36px;margin:6px 0}
  .timer-controls{display:flex;gap:8px;margin-top:8px}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;background:var(--accent);color:#081414;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);font-weight:600}

  .shop{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .shop .item{background:var(--panel);padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:6px;width:130px}
  .small{font-size:12px;color:var(--muted)}

  <!-- calendar container -->
<div id="calendar"></div>

<!-- modal -->
<div id="eventModal" class="modal hidden">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2 id="modalDate"></h2>
    <input type="text" id="eventTitle" placeholder="event/task title">
    <textarea id="eventDesc" placeholder="details..."></textarea>
    <button id="saveEvent">save</button>
    <div id="eventList"></div>
  </div>
</div>

<style>
/* calendar */
#calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  background: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 12px;
}
.calendar-day {
  padding: 10px;
  background: rgba(255,255,255,0.08);
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: background 0.2s ease;
}
.calendar-day:hover {
  background: rgba(255,255,255,0.15);
}

/* modal */
.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.6);
  z-index: 999;
}
.modal.hidden { display: none; }
.modal-content {
  background: #1a1a1a;
  padding: 20px;
  border-radius: 12px;
  width: 300px;
  color: #eee;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
.modal-content input,
.modal-content textarea {
  width: 100%;
  background: #0e0e0e;
  border: none;
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  color: #eee;
}
.modal-content button {
  background: #4a4a4a;
  border: none;
  padding: 8px 12px;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}
.close {
  float: right;
  cursor: pointer;
}
</style>

<script>
const calendar = document.getElementById('calendar');
const modal = document.getElementById('eventModal');
const modalDate = document.getElementById('modalDate');
const closeModal = document.querySelector('.close');
const saveEventBtn = document.getElementById('saveEvent');
const eventTitle = document.getElementById('eventTitle');
const eventDesc = document.getElementById('eventDesc');
const eventList = document.getElementById('eventList');

let selectedDate = '';
let events = JSON.parse(localStorage.getItem('calendarEvents')) || {};

function renderCalendar() {
  const now = new Date();
  const month = now.getMonth();
  const year = now.getFullYear();
  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  calendar.innerHTML = '';
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    calendar.appendChild(empty);
  }

  for (let day = 1; day <= lastDate; day++) {
    const dayEl = document.createElement('div');
    dayEl.classList.add('calendar-day');
    dayEl.textContent = day;
    dayEl.addEventListener('click', () => openModal(`${year}-${month+1}-${day}`));
    calendar.appendChild(dayEl);
  }
}

function openModal(date) {
  selectedDate = date;
  modalDate.textContent = new Date(date).toDateString();
  eventTitle.value = '';
  eventDesc.value = '';
  renderEventList();
  modal.classList.remove('hidden');
}

function closeModalFn() {
  modal.classList.add('hidden');
}

function saveEvent() {
  if (!events[selectedDate]) events[selectedDate] = [];
  events[selectedDate].push({
    title: eventTitle.value,
    desc: eventDesc.value
  });
  localStorage.setItem('calendarEvents', JSON.stringify(events));
  renderEventList();
  eventTitle.value = '';
  eventDesc.value = '';
}

function renderEventList() {
  eventList.innerHTML = '';
  if (events[selectedDate]) {
    events[selectedDate].forEach(ev => {
      const evDiv = document.createElement('div');
      evDiv.innerHTML = `<strong>${ev.title}</strong><p>${ev.desc}</p>`;
      evDiv.style.marginTop = '8px';
      evDiv.style.padding = '6px';
      evDiv.style.background = 'rgba(255,255,255,0.05)';
      evDiv.style.borderRadius = '6px';
      eventList.appendChild(evDiv);
    });
  }
}

closeModal.addEventListener('click', closeModalFn);
saveEventBtn.addEventListener('click', saveEvent);

renderCalendar();
</script>


  .confetti {
    position:relative;pointer-events:none;
  }
  .confetti .dot{
    position:absolute;width:8px;height:8px;border-radius:3px;animation:pop .9s ease-out forwards;
  }
  @keyframes pop {
    0% { transform: translateY(0) scale(0.2); opacity:1 }
    100% { transform: translateY(-90px) translateX(30px) rotate(180deg) scale(1); opacity:0 }
  } 
</style>
</head>
<body>
  <div id="app" class="">
    <div class="app" id="appgrid">
      <header>
        <div class="title">
          <div class="logo">v</div>
          <div>
            <h1>vibe productivity hub</h1>
            <div class="streak"><span id="streakText">streak: 0</span></div>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div class="points" title="points you can spend">
            <div style="font-weight:700" id="points">0</div>
            <div class="small">points</div>
          </div>
          <button class="btn secondary" id="openShopBtn">shop</button>
        </div>
      </header>

      <main>
        <section class="left">
          <div>
            <p class="panel-title">mood tracker</p>
            <div class="mood-row" id="moodBtns">
              <!-- buttons injected by js -->
            </div>

            <div class="mood-history">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="small">mood history (last 14 days)</div>
                <button id="clearMood" class="btn secondary" style="padding:6px 8px">clear</button>
              </div>
              <canvas id="moodCanvas" width="700" height="120" style="width:100%;height:60px;margin-top:8px;border-radius:8px"></canvas>
            </div>
          </div>

          <hr style="margin:14px 0;border:0;border-top:1px solid rgba(255,255,255,0.03)">

          <div>
            <p class="panel-title">daily quick</p>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="text" id="quickTask" placeholder="add quick task..." />
              <select id="quickCat">
                <option value="school">school</option>
                <option value="chores">chores</option>
                <option value="personal">personal</option>
              </select>
              <button id="addQuick" class="btn">add</button>
            </div>
            <div style="margin-top:10px" id="todoContainer">
              <div class="todo-list" id="todoList"></div>
            </div>
          </div>
        </section>

        <section class="middle">
          <div>
            <p class="panel-title">calendar planner</p>
            <div class="calendar-container">
              <div class="calendar-header">
                <button class="calendar-nav" id="prevMonth">â€¹</button>
                <div style="font-weight:600" id="calendarTitle">January 2025</div>
                <button class="calendar-nav" id="nextMonth">â€º</button>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div class="event-form" id="eventForm" style="display:none">
              <div style="font-weight:600;margin-bottom:8px">add event for <span id="selectedDate"></span></div>
              <div class="form-row">
                <input type="text" id="eventTitle" placeholder="event title" />
              </div>
              <div class="form-row">
                <input type="time" id="eventTime" />
                <select id="eventCategory">
                  <option value="school">school</option>
                  <option value="personal">personal</option>
                  <option value="work">work</option>
                  <option value="social">social</option>
                </select>
              </div>
              <div style="display:flex;gap:8px">
                <button id="saveEvent" class="btn">save</button>
                <button id="cancelEvent" class="btn secondary">cancel</button>
              </div>
            </div>

            <div class="events-list" id="eventsList"></div>
          </div>
        </section>

        <section class="right">
          <div>
            <p class="panel-title">pomodoro study timer</p>
            <div class="timer" id="timerCard">
              <div class="small">session length (min)</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="workLen" type="number" value="25" min="5" style="width:80px"/>
                <input id="breakLen" type="number" value="5" min="1" style="width:80px"/>
              </div>

              <div class="time-display" id="timeDisplay">25:00</div>
              <div class="timer-controls">
                <button id="startPause" class="btn">start</button>
                <button id="skip" class="btn secondary">skip</button>
                <button id="reset" class="btn secondary">reset</button>
              </div>
              <div style="margin-top:8px;color:var(--muted);font-size:13px">mode: <span id="timerMode">work</span></div>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;gap:12px;flex-direction:column">
            <div>
              <p class="panel-title">rewards shop</p>
              <div class="shop" id="shop">
                <div class="item">
                  <div style="font-weight:700">goth theme</div>
                  <div class="small">cost: 200</div>
                  <button data-item="goth" class="btn buy">buy</button>
                </div>
                <div class="item">
                  <div style="font-weight:700">pastel theme</div>
                  <div class="small">cost: 150</div>
                  <button data-item="pastel" class="btn buy">buy</button>
                </div>
                <div class="item">
                  <div style="font-weight:700">cottage theme</div>
                  <div class="small">cost: 100</div>
                  <button data-item="cottage" class="btn buy">buy</button>
                </div>
              </div>
            </div>

            <div>
              <p class="panel-title">profile</p>
              <div style="background:var(--panel);padding:12px;border-radius:10px">
                <div style="font-weight:700" id="profileName">you</div>
                <div class="small" style="margin-top:6px">stickers unlocked:</div>
                <div id="stickers" style="display:flex;gap:6px;margin-top:8px">
                  <!-- little sticker placeholders -->
                </div>
                <div style="margin-top:10px">
                  <button id="useTheme" class="btn secondary">apply unlocked theme</button>
                </div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

<script>
/*
  features:
   - mood tracker (14-day history, canvas chart, localStorage)
   - todo list with categories (localStorage, points for completing)
   - pomodoro timer (work/break, adjustable, points for full sessions)
   - simple shop unlocking themes (spend points)
   - streak: log mood + complete a task each day keeps streak
   - calendar planner (add/view/delete events by date)
*/

const MOODS = [
  {id:6, emoji:'ðŸ˜„', label:'great'},
  {id:5, emoji:'ðŸ™‚', label:'good'},
  {id:4, emoji:'ðŸ˜', label:'meh'},
  {id:3, emoji:'ðŸ˜¡', label:'angry'},
  {id:2, emoji:'ðŸ˜•', label:'down'},
  {id:1, emoji:'ðŸ˜«', label:'awful'},
  {id:0, emoji:'ðŸ«¥', label:'numb'}
];

const DEFAULTS = {
  points: 0,
  streak: 0,
  lastStreakDate: null,
  moods: [], // {date: 'YYYY-MM-DD', moodId: n}
  todos: [], // {id, text, cat, done, created}
  events: [], // {id, date: 'YYYY-MM-DD', title, time, category, created}
  shop: { goth:false, pastel:false, cottage:false },
  appliedTheme: null
};

// storage helpers
function load(){ return JSON.parse(localStorage.getItem('vibe_data')||'null') || DEFAULTS; }
function save(state){ localStorage.setItem('vibe_data', JSON.stringify(state)); }

// app state
let state = load();

// calendar state
let currentCalendarDate = new Date();
let selectedCalendarDate = null;

// dom refs
const moodBtns = document.getElementById('moodBtns');
const moodCanvas = document.getElementById('moodCanvas');
const todoList = document.getElementById('todoList');
const pointsEl = document.getElementById('points');
const streakText = document.getElementById('streakText');
const quickTask = document.getElementById('quickTask');
const quickCat = document.getElementById('quickCat');
const addQuick = document.getElementById('addQuick');
const workLen = document.getElementById('workLen');
const breakLen = document.getElementById('breakLen');
const timeDisplay = document.getElementById('timeDisplay');
const startPause = document.getElementById('startPause');
const skipBtn = document.getElementById('skip');
const resetBtn = document.getElementById('reset');
const timerMode = document.getElementById('timerMode');
const buyBtns = document.querySelectorAll('.buy');
const openShopBtn = document.getElementById('openShopBtn');
const useThemeBtn = document.getElementById('useTheme');
const stickersEl = document.getElementById('stickers');
const clearMoodBtn = document.getElementById('clearMood');

// calendar refs
const calendarGrid = document.getElementById('calendarGrid');
const calendarTitle = document.getElementById('calendarTitle');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const eventForm = document.getElementById('eventForm');
const selectedDateEl = document.getElementById('selectedDate');
const eventTitle = document.getElementById('eventTitle');
const eventTime = document.getElementById('eventTime');
const eventCategory = document.getElementById('eventCategory');
const saveEvent = document.getElementById('saveEvent');
const cancelEvent = document.getElementById('cancelEvent');
const eventsList = document.getElementById('eventsList');

function formatDate(d){ return d.toISOString().slice(0,10); }

// init ui
function init(){
  renderMoodButtons();
  renderMoodCanvas();
  renderTodos();
  renderCalendar();
  renderUpcomingEvents();
  updateProfileUI();
  updatePointsUI();
  updateStreakUI();
  applyTheme(state.appliedTheme);
}
init();

function renderMoodButtons(){
  moodBtns.innerHTML = '';
  MOODS.forEach(m=>{
    const btn = document.createElement('button');
    btn.className = 'mood-btn';
    btn.innerHTML = `${m.emoji} <span style="margin-left:8px;font-size:13px;color:var(--muted)">${m.label}</span>`;
    btn.onclick = ()=> logMood(m.id);
    moodBtns.appendChild(btn);
  });
}

function logMood(moodId){
  const today = formatDate(new Date());
  // remove existing for today
  state.moods = state.moods.filter(m=>m.date!==today);
  state.moods.push({date:today, moodId});
  // trim to last 30
  if(state.moods.length>60) state.moods.splice(0,state.moods.length-60);
  save(state);
  renderMoodCanvas();
  updateStreakOnMood(today);
}

function renderMoodCanvas(){
  const canvas = moodCanvas;
  const ctx = canvas.getContext('2d');
  const days = 14;
  const arr = [];
  const today = new Date();
  for(let i=days-1;i>=0;i--){
    const d = new Date(today); d.setDate(today.getDate()-i);
    const key = formatDate(d);
    const found = state.moods.find(m=>m.date===key);
    arr.push(found ? found.moodId : null);
  }
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const w = canvas.width;
  const h = canvas.height;
  const pad = 10;
  const cellW = (w - pad*2) / days;
  for(let i=0;i<days;i++){
    const val = arr[i];
    const x = pad + i*cellW;
    const barH = val ? ( (val/5) * (h - pad*2) ) : 6;
    ctx.fillStyle = val ? 'rgba(0,191,166,0.9)' : 'rgba(255,255,255,0.04)';
    ctx.fillRect(x+6, h - pad - barH, cellW - 12, barH);
  }
  for(let i=0;i<days;i++){
    const val = arr[i];
    const x = pad + i*cellW + cellW/2;
    if(val){
      const y = h - pad - (val/5)*(h - pad*2) - 8;
      ctx.beginPath();
      ctx.arc(x,y,6,0,Math.PI*2);
      ctx.fillStyle = 'var(--accent)';
      ctx.fill();
    }
  }
}

clearMoodBtn.onclick = ()=>{
  if(!confirm('clear mood history?')) return;
  state.moods = [];
  save(state);
  renderMoodCanvas();
};

function renderTodos(){
  todoList.innerHTML = '';
  state.todos.sort((a,b)=> b.created - a.created);
  for(const t of state.todos){
    const el = document.createElement('div');
    el.className = 'task';
    el.innerHTML = `
      <button class="check-btn">${t.done ? 'âœ“' : ''}</button>
      <div class="label">
        <div style="font-weight:700; color:${t.done ? 'var(--muted)' : 'var(--text)'}">${escapeHtml(t.text)}</div>
        <div class="cat">${escapeHtml(t.cat)}</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn secondary edit">edit</button>
        <button class="btn secondary del">del</button>
      </div>
    `;
    el.querySelector('.check-btn').onclick = ()=>{
      toggleTaskDone(t.id, el);
    };
    el.querySelector('.del').onclick = ()=> {
      if(!confirm('delete task?')) return;
      state.todos = state.todos.filter(x=>x.id!==t.id);
      save(state); renderTodos();
    };
    el.querySelector('.edit').onclick = ()=>{
      const newText = prompt('edit task text', t.text);
      if(newText!==null){
        t.text = newText.trim() || t.text;
        save(state); renderTodos();
      }
    };
    todoList.appendChild(el);
  }
}

function addTask(text, cat='personal'){
  const id = Math.random().toString(36).slice(2,9);
  const task = {id, text, cat, done:false, created:Date.now()};
  state.todos.push(task);
  save(state);
  renderTodos();
}

addQuick.onclick = ()=>{
  const txt = quickTask.value.trim();
  if(!txt) return;
  addTask(txt, quickCat.value);
  quickTask.value = '';
};

function toggleTaskDone(id, el){
  const t = state.todos.find(x=>x.id===id);
  if(!t) return;
  t.done = !t.done;
  if(t.done){
    addPoints(12);
    spawnConfetti(el);
    const today = formatDate(new Date());
    if(state.moods.find(m=>m.date===today)) {
      updateStreakOnTask(today);
    }
  }
  save(state);
  renderTodos();
}

function addPoints(n){
  state.points = (state.points||0) + n;
  save(state);
  updatePointsUI();
}

function updatePointsUI(){
  pointsEl.textContent = state.points || 0;
}

// Calendar functions
function renderCalendar(){
  const year = currentCalendarDate.getFullYear();
  const month = currentCalendarDate.getMonth();
  
  calendarTitle.textContent = new Date(year, month).toLocaleDateString('en-US', {month:'long', year:'numeric'});
  
  // Clear grid
  calendarGrid.innerHTML = '';
  
  // Add day headers
  const dayHeaders = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  dayHeaders.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-day-header';
    header.textContent = day;
    calendarGrid.appendChild(header);
  });
  
  // Get first day of month and days in month
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startDay = firstDay.getDay();
  
  // Add previous month's trailing days
  if(startDay > 0) {
    const prevMonthDate = new Date(year, month - 1, 0);
    for(let i = startDay - 1; i >= 0; i--){
      const dayNum = prevMonthDate.getDate() - i;
      const dayEl = createCalendarDay(dayNum, true, new Date(year, month - 1, dayNum));
      calendarGrid.appendChild(dayEl);
    }
  }
  
  // Add current month days
  for(let day = 1; day <= daysInMonth; day++){
    const date = new Date(year, month, day);
    const dayEl = createCalendarDay(day, false, date);
    calendarGrid.appendChild(dayEl);
  }
  
  // Add next month's leading days to fill remaining cells
  const cellsUsed = startDay + daysInMonth;
  const remainingCells = Math.ceil(cellsUsed / 7) * 7 - cellsUsed;
  for(let day = 1; day <= remainingCells; day++){
    const dayEl = createCalendarDay(day, true, new Date(year, month + 1, day));
    calendarGrid.appendChild(dayEl);
  }
}

function createCalendarDay(dayNum, isOtherMonth, date){
  const dayEl = document.createElement('div');
  dayEl.className = 'calendar-day';
  if(isOtherMonth) dayEl.classList.add('other-month');
  
  const today = new Date();
  if(formatDate(date) === formatDate(today)) {
    dayEl.classList.add('today');
  }
  
  // Check if day has events
  const dateStr = formatDate(date);
  const dayEvents = state.events.filter(e => e.date === dateStr);
  if(dayEvents.length > 0) {
    dayEl.classList.add('has-events');
  }
  
  dayEl.innerHTML = `
    <div class="day-number">${dayNum}</div>
    ${dayEvents.slice(0,2).map(() => '<div class="event-dot"></div>').join('')}
  `;
  
  dayEl.onclick = () => selectDate(date);
  
  return dayEl;
}

function selectDate(date){
  selectedCalendarDate = date;
  const dateStr = formatDate(date);
  selectedDateEl.textContent = date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
  eventForm.style.display = 'block';
  eventTitle.value = '';
  eventTime.value = '';
  renderDayEvents(dateStr);
}

function renderDayEvents(dateStr){
  const dayEvents = state.events.filter(e => e.date === dateStr);
  eventsList.innerHTML = '';
  
  if(dayEvents.length === 0){
    eventsList.innerHTML = '<div class="small" style="padding:8px;text-align:center;color:var(--muted)">no events for this day</div>';
    return;
  }
  
  dayEvents.sort((a,b) => (a.time || '').localeCompare(b.time || ''));
  
  dayEvents.forEach(event => {
    const eventEl = document.createElement('div');
    eventEl.className = 'event-item';
    eventEl.innerHTML = `
      <div class="event-details">
        <div class="event-title">${escapeHtml(event.title)}</div>
        <div class="event-time">${event.time || 'all day'} â€¢ ${event.category}</div>
      </div>
      <div class="event-actions">
        <button class="btn secondary delete-event" data-id="${event.id}">Ã—</button>
      </div>
    `;
    eventsList.appendChild(eventEl);
  });
  
  // Add delete event listeners
  document.querySelectorAll('.delete-event').forEach(btn => {
    btn.onclick = () => {
      const eventId = btn.dataset.id;
      if(confirm('delete this event?')) {
        state.events = state.events.filter(e => e.id !== eventId);
        save(state);
        renderCalendar();
        renderDayEvents(dateStr);
        renderUpcomingEvents();
      }
    };
  });
}

function renderUpcomingEvents(){
  // This could show next few events in a separate area if needed
  // For now, events are shown when a day is selected
}

prevMonth.onclick = () => {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
  renderCalendar();
};

nextMonth.onclick = () => {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
  renderCalendar();
};

saveEvent.onclick = () => {
  const title = eventTitle.value.trim();
  if(!title) return;
  
  const event = {
    id: Math.random().toString(36).slice(2,9),
    date: formatDate(selectedCalendarDate),
    title: title,
    time: eventTime.value,
    category: eventCategory.value,
    created: Date.now()
  };
  
  state.events.push(event);
  save(state);
  
  // Award points for planning ahead
  addPoints(5);
  
  eventForm.style.display = 'none';
  renderCalendar();
  renderUpcomingEvents();
  
  // Show success
  alert('event added! +5 points for planning ahead');
};

cancelEvent.onclick = () => {
  eventForm.style.display = 'none';
  eventTitle.value = '';
  eventTime.value = '';
};

buyBtns.forEach(b=>{
  b.onclick = ()=>{
    const item = b.dataset.item;
    const cost = item==='goth' ? 200 : (item==='pastel' ? 150 : 100);
    if(state.shop[item]){
      alert('already bought!');
      return;
    }
    if(state.points < cost){
      alert('not enough points yet!');
      return;
    }
    state.points -= cost;
    state.shop[item] = true;
    state.appliedTheme = item;
    save(state);
    updatePointsUI();
    applyTheme(item);
    updateProfileUI();
    alert('bought! theme unlocked and applied');
  };
});

openShopBtn.onclick = ()=> {
  document.getElementById('shop').scrollIntoView({behavior:'smooth', block:'center'});
};

useThemeBtn.onclick = ()=>{
  const unlocked = Object.keys(state.shop).filter(k=>state.shop[k]);
  if(!unlocked.length){ alert('no themes unlocked yet'); return; }
  const pick = unlocked[0];
  state.appliedTheme = pick;
  save(state);
  applyTheme(pick);
  alert('applied: ' + pick);
};

function updateProfileUI(){
  stickersEl.innerHTML = '';
  const keys = Object.keys(state.shop);
  keys.forEach(k=>{
    if(state.shop[k]){
      const s = document.createElement('div');
      s.style.width='28px';s.style.height='28px';s.style.borderRadius='6px';
      s.style.background='linear-gradient(135deg,var(--accent),var(--accent-2))';
      s.title = k + ' theme';
      stickersEl.appendChild(s);
    }
  });
}

let timer = {
  running:false,
  mode:'work',
  remain: null,
  intervalId: null
};

function setTimerMinutes(mins){
  timer.remain = mins * 60;
  renderTimerDisplay();
}

function renderTimerDisplay(){
  const mm = Math.floor(timer.remain/60).toString().padStart(2,'0');
  const ss = (timer.remain%60).toString().padStart(2,'0');
  timeDisplay.textContent = `${mm}:${ss}`;
  timerMode.textContent = timer.mode;
}

function startTimer(){
  if(timer.running) return;
  if(timer.remain===null) setTimerMinutes(parseInt(workLen.value,10)||25);
  timer.running = true;
  startPause.textContent = 'pause';
  timer.intervalId = setInterval(()=>{
    timer.remain--;
    if(timer.remain<=0){
      clearInterval(timer.intervalId);
      timer.running=false;
      startPause.textContent='start';
      if(timer.mode==='work') {
        addPoints(25);
        alert('nice! you finished a work session and earned 25 points');
      }
      if(timer.mode==='work'){ timer.mode='break'; setTimerMinutes(parseInt(breakLen.value,10)||5); }
      else { timer.mode='work'; setTimerMinutes(parseInt(workLen.value,10)||25); }
      renderTimerDisplay();
    } else {
      renderTimerDisplay();
    }
  },1000);
}

function pauseTimer(){
  if(!timer.running) return;
  clearInterval(timer.intervalId);
  timer.running=false;
  startPause.textContent='start';
}

startPause.onclick = ()=>{
  if(timer.running){ pauseTimer(); } else { startTimer(); }
};

skipBtn.onclick = ()=>{
  if(timer.intervalId) clearInterval(timer.intervalId);
  timer.running=false;
  if(timer.mode==='work'){ timer.mode='break'; setTimerMinutes(parseInt(breakLen.value,10)||5); }
  else { timer.mode='work'; setTimerMinutes(parseInt(workLen.value,10)||25); }
  renderTimerDisplay();
};

resetBtn.onclick = ()=>{
  if(timer.intervalId) clearInterval(timer.intervalId);
  timer.running=false;
  timer.mode='work';
  setTimerMinutes(parseInt(workLen.value,10)||25);
  startPause.textContent='start';
};

setTimerMinutes(parseInt(workLen.value,10)||25);

function escapeHtml(s){
  return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function spawnConfetti(el){
  const conf = document.createElement('div');
  conf.className='confetti';
  conf.style.width='1px'; conf.style.height='1px';
  el.appendChild(conf);
  for(let i=0;i<6;i++){
    const d = document.createElement('div');
    d.className='dot';
    d.style.left = (Math.random()*40) + 'px';
    d.style.top = (Math.random()*10) + 'px';
    d.style.background = ['#ffd166','#06d6a0','#ef476f','#118ab2','#ffb4a2'][Math.floor(Math.random()*5)];
    conf.appendChild(d);
  }
  setTimeout(()=> conf.remove(), 900);
}

function updateStreakOnMood(today){
  if(!state.lastStreakDate) state.lastStreakDate = null;
  save(state);
  updateStreakUI();
}

function updateStreakOnTask(today){
  if(!state.moods.find(m=>m.date===today)) return;
  const last = state.lastStreakDate;
  if(last===null){
    state.streak = 1;
  } else {
    const lastDate = new Date(last);
    const expected = new Date(today); expected.setDate(expected.getDate()-1);
    const expectedStr = formatDate(expected);
    if(formatDate(lastDate) === expectedStr) state.streak = (state.streak||0) + 1;
    else state.streak = 1;
  }
  state.lastStreakDate = today;
  addPoints(10);
  save(state);
  updateStreakUI();
}

function updateStreakUI(){
  streakText.textContent = 'streak: ' + (state.streak || 0);
}

function applyTheme(name){
  document.documentElement.classList.remove('theme-goth','theme-cottage','theme-pastel');
  if(!name) return;
  if(name==='goth') document.documentElement.classList.add('theme-goth');
  if(name==='cottage') document.documentElement.classList.add('theme-cottage');
  if(name==='pastel') document.documentElement.classList.add('theme-pastel');
}

(function loadFromStorage(){
  if(typeof state.points === 'undefined') state.points = 0;
  if(!Array.isArray(state.todos)) state.todos = [];
  if(!Array.isArray(state.events)) state.events = [];
  if(!state.shop) state.shop = {goth:false,pastel:false,cottage:false};
  save(state);
})();

document.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && document.activeElement===quickTask) { addQuick.click(); }
  if(e.key==='Enter' && document.activeElement===eventTitle) { saveEvent.click(); }
  if(e.key==='Escape' && eventForm.style.display !== 'none') { cancelEvent.click(); }
});

if(state.appliedTheme) applyTheme(state.appliedTheme);

window.addEventListener('beforeunload', ()=> save(state));

</script>
</body>
</html>
